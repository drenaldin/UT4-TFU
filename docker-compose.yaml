version: "3.9"

services:
  # --- NUEVO: API Gateway ---
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "8080:8080" # Punto de entrada único
    depends_on:
      - users-service
      - projects-service
      - tasks-service
      - redis
    environment:
      - SPRING_PROFILES_ACTIVE=docker

  # --- Servicios Backend (Puertos internos modificados para evitar colisión si es necesario) ---
  users-service:
    build: ./users-service
    container_name: users-service
    # No es estrictamente necesario exponer puertos si usas la red interna de docker,
    # pero útil para debug. El gateway usa http://users-service:8080 (puerto interno del contenedor)
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_users:5432/usersdb
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=pass
    depends_on:
      db_users:
        condition: service_started
    healthcheck: # Health Endpoint Monitoring
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3
  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
  projects-service:
    build: ./projects-service
    container_name: projects-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_projects:5432/projectsdb
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=pass
    depends_on:
      db_projects:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  tasks-service:
    build: ./tasks-service
    container_name: tasks-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db_tasks:5432/tasksdb
      - SPRING_DATASOURCE_USERNAME=user
      - SPRING_DATASOURCE_PASSWORD=pass
    depends_on:
      db_tasks:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Bases de datos (sin cambios, solo asegurar nombres)
  db_users:
    image: postgres:15
    container_name: db_users
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: usersdb

  db_projects:
    image: postgres:15
    container_name: db_projects
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: projectsdb

  db_tasks:
    image: postgres:15
    container_name: db_tasks
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: tasksdb